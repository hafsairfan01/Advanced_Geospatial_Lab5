<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MQTT Connection</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label, input {
      display: inline-block;
      margin-top: 10px;
      width: 200px;
    }
    input {
      padding: 5px;
    }
    button {
      margin-top: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>MQTT Connection</h1>
  <!-- Host and Port Inputs -->
  <div>
    <label for="host">Broker Host:</label>
    <input type="text" id="host" value="test.mosquitto.org" placeholder="e.g. test.mosquitto.org">
  </div>
  <div>
    <label for="port">Broker Port:</label>
    <input type="number" id="port" value="8080" placeholder="e.g. 8080">
  </div>

  <!-- Start/End Buttons -->
  <button id="startBtn">Start</button>
  <button id="endBtn" disabled>End</button>

  <!-- Status Output -->
  <div id="status"></div>

  <!-- Include Paho MQTT JavaScript Client Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

  <script>
    let client = null;
    let isConnected = false;
    let isManualDisconnect = false;  // Tracks whether user clicked "End" or disconnection was unexpected
    const reconnectDelay = 3000;     // 3 seconds delay before auto-reconnect

    // Update status text on the page and log to console
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
      console.log(message);
    }

    // Connect to MQTT Broker
    function connectMQTT() {
      // If we're trying to connect, it means disconnection wasn't manual
      isManualDisconnect = false;

      const host = document.getElementById('host').value;
      const port = parseInt(document.getElementById('port').value);

      // Generate a random client ID
      const clientId = "client_" + Math.random().toString(16).substr(2, 8);

      // Create a new Paho MQTT client
      client = new Paho.MQTT.Client(host, port, clientId);

      // Set callback handlers
      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;  // Not used yet, but in place for future

      // Connect the client
      const options = {
        timeout: 3,
        onSuccess: onConnect,
        onFailure: function(error) {
          updateStatus("Connection failed: " + error.errorMessage);
          // Attempt to reconnect if it wasn't a manual disconnect
          if (!isManualDisconnect) {
            updateStatus("Attempting to reconnect in " + (reconnectDelay / 1000) + "s...");
            setTimeout(connectMQTT, reconnectDelay);
          }
        }
      };

      updateStatus("Connecting to " + host + ":" + port + " ...");
      client.connect(options);
    }

    // Called when the client connects
    function onConnect() {
      isConnected = true;
      updateStatus("Connected to the MQTT broker.");
      // Disable host/port inputs, disable start button, enable end button
      document.getElementById('host').disabled = true;
      document.getElementById('port').disabled = true;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('endBtn').disabled = false;
    }

    // Called when the client loses its connection
    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        updateStatus("Connection lost: " + responseObject.errorMessage);
      }
      isConnected = false;

      // If user didn't manually disconnect, attempt auto-reconnect
      if (!isManualDisconnect) {
        updateStatus("Connection lost unexpectedly. Attempting to reconnect in " 
          + (reconnectDelay / 1000) + "s...");
        setTimeout(connectMQTT, reconnectDelay);
      } else {
        // If disconnection was manual, reset the UI so user can modify host/port or reconnect
        document.getElementById('host').disabled = false;
        document.getElementById('port').disabled = false;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('endBtn').disabled = true;
      }
    }

    // Called when a message arrives
    function onMessageArrived(message) {
      console.log("Message arrived: " + message.payloadString);
      // Future use: handle incoming MQTT messages
    }

    // Disconnect from the MQTT broker
    function disconnectMQTT() {
      if (client && isConnected) {
        // Mark this as a manual disconnect
        isManualDisconnect = true;
        client.disconnect();
        isConnected = false;
        updateStatus("Disconnected from the MQTT broker.");
      }
      // Re-enable fields/buttons
      document.getElementById('host').disabled = false;
      document.getElementById('port').disabled = false;
      document.getElementById('startBtn').disabled = false;
      document.getElementById('endBtn').disabled = true;
    }

    // Event Listeners for Start/End buttons
    document.getElementById('startBtn').addEventListener('click', connectMQTT);
    document.getElementById('endBtn').addEventListener('click', disconnectMQTT);
  </script>
</body>
</html>
