<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MQTT Connection & Publish</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label, input, textarea {
      display: inline-block;
      margin-top: 10px;
    }
    label {
      width: 120px;
    }
    input, textarea {
      padding: 5px;
      width: 250px;
    }
    button {
      margin-top: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
    }
    .row {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>MQTT Connection & Publish</h1>

  <!-- Host and Port Inputs -->
  <div class="row">
    <label for="host">Broker Host:</label>
    <input type="text" id="host" value="test.mosquitto.org" placeholder="e.g. test.mosquitto.org">
  </div>
  <div class="row">
    <label for="port">Broker Port:</label>
    <input type="number" id="port" value="8080" placeholder="e.g. 8080">
  </div>

  <!-- Start/End Buttons -->
  <button id="startBtn">Start</button>
  <button id="endBtn" disabled>End</button>

  <hr>

  <!-- Topic and Message Inputs -->
  <div class="row">
    <label for="topic">Topic:</label>
    <input type="text" id="topic" value="test/topic" placeholder="Enter a topic">
  </div>
  <div class="row">
    <label for="message">Message:</label>
    <textarea id="message" rows="3" placeholder="Type your message here"></textarea>
  </div>
  <button id="publishBtn" disabled>Publish</button>

  <hr>

  <!-- Share My Status Button -->
  <button id="shareStatusBtn" disabled>Share My Status</button>

  <!-- Status Output -->
  <div id="status"></div>

  <!-- Include Paho MQTT JavaScript Client Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

  <script>
    let client = null;
    let isConnected = false;
    let isManualDisconnect = false;  // For auto-reconnect logic
    const reconnectDelay = 3000;     // For auto-reconnect logic

    // Update status text on the page and log to console
    function updateStatus(message) {
      document.getElementById('status').textContent = message;
      console.log(message);
    }

    // Connect to MQTT Broker
    function connectMQTT() {
      // reset isManualDisconnect
      isManualDisconnect = false;

      const host = document.getElementById('host').value;
      const port = parseInt(document.getElementById('port').value);

      // Generate a random client ID
      const clientId = "client_" + Math.random().toString(16).substr(2, 8);

      // Create a new Paho MQTT client
      client = new Paho.MQTT.Client(host, port, clientId);

      // Set callback handlers
      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;  // Not used yet, but in place for future

      // Connect the client
      const options = {
        timeout: 3,
        onSuccess: onConnect,
        onFailure: function(error) {
          updateStatus("Connection failed: " + error.errorMessage);
        }
      };

      updateStatus("Connecting to " + host + ":" + port + " ...");
      client.connect(options);
    }

    // Called when the client connects
    function onConnect() {
      isConnected = true;
      updateStatus("Connected to the MQTT broker.");
      // Disable host/port inputs, disable start button, enable end button
      document.getElementById('host').disabled = true;
      document.getElementById('port').disabled = true;
      document.getElementById('startBtn').disabled = true;
      document.getElementById('endBtn').disabled = false;

      // Enable Publish and Share Status buttons now that we're connected
      document.getElementById('publishBtn').disabled = false;
      document.getElementById('shareStatusBtn').disabled = false;
    }

    // Called when the client loses its connection
    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        updateStatus("Connection lost: " + responseObject.errorMessage);
      }
      isConnected = false;
      // Re-enable fields/buttons so the user can reconnect
      document.getElementById('host').disabled = false;
      document.getElementById('port').disabled = false;
      document.getElementById('startBtn').disabled = false;
      document.getElementById('endBtn').disabled = true;

      // Disable Publish and Share Status buttons if we're disconnected
      document.getElementById('publishBtn').disabled = true;
      document.getElementById('shareStatusBtn').disabled = true;
    }

    // Called when a message arrives
    function onMessageArrived(message) {
      console.log("Message arrived: " + message.payloadString);
      // Future use: handle incoming MQTT messages
    }

    // Disconnect from the MQTT broker
    function disconnectMQTT() {
      if (client && isConnected) {
        // For auto-reconnect logic, mark this as manual
        isManualDisconnect = true;

        client.disconnect();
        isConnected = false;
        updateStatus("Disconnected from the MQTT broker.");
      }
      // Re-enable fields/buttons
      document.getElementById('host').disabled = false;
      document.getElementById('port').disabled = false;
      document.getElementById('startBtn').disabled = false;
      document.getElementById('endBtn').disabled = true;

      // Disable Publish and Share Status buttons
      document.getElementById('publishBtn').disabled = true;
      document.getElementById('shareStatusBtn').disabled = true;
    }

    // Publish a message to the specified topic (from user input)
    function publishMessage() {
      if (!client || !isConnected) {
        updateStatus("Not connected. Please connect first.");
        return;
      }

      const topic = document.getElementById('topic').value;
      const msg = document.getElementById('message').value;

      if (!topic) {
        updateStatus("Please enter a topic.");
        return;
      }

      if (!msg) {
        updateStatus("Please enter a message.");
        return;
      }

      const message = new Paho.MQTT.Message(msg);
      message.destinationName = topic;

      try {
        client.send(message);
        updateStatus(`Published message to topic "${topic}": ${msg}`);
      } catch (error) {
        updateStatus("Error publishing message: " + error);
      }
    }

    // "Share My Status" - publish a GeoJSON with current location and random temperature
    // using the *same* topic as typed in the "Topic" field
    function shareMyStatus() {
      if (!client || !isConnected) {
        updateStatus("Not connected. Please connect first.");
        return;
      }

      // Check if geolocation is supported
      if (!navigator.geolocation) {
        updateStatus("Geolocation is not supported by your browser.");
        return;
      }

      // Read the topic from the user input
      const shareTopic = document.getElementById('topic').value;
      if (!shareTopic) {
        updateStatus("Please enter a topic for sharing your status.");
        return;
      }

      // Get current position
      navigator.geolocation.getCurrentPosition(
        function(position) {
          // Generate a random temperature between -40 and 60
          const temperature = Math.floor(Math.random() * 101) - 40; 
          // Build GeoJSON
          const geojson = {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [ position.coords.longitude, position.coords.latitude ]
            },
            properties: {
              temperature: temperature
            }
          };

          // Publish this GeoJSON to the user-defined topic
          const payload = JSON.stringify(geojson);
          const message = new Paho.MQTT.Message(payload);
          message.destinationName = shareTopic;

          try {
            client.send(message);
            updateStatus(`Shared status to topic "${shareTopic}": ${payload}`);
          } catch (error) {
            updateStatus("Error publishing GeoJSON status: " + error);
          }
        },
        function(error) {
          updateStatus("Error getting location: " + error.message);
        }
      );
    }

    // Event Listeners
    document.getElementById('startBtn').addEventListener('click', connectMQTT);
    document.getElementById('endBtn').addEventListener('click', disconnectMQTT);
    document.getElementById('publishBtn').addEventListener('click', publishMessage);
    document.getElementById('shareStatusBtn').addEventListener('click', shareMyStatus);
  </script>
</body>
</html>
